<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Visit Tracker — Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Inter,sans-serif; margin:0; background:#f7f9fb; color:#0f172a; padding:24px; }
        .card { background:#fff; border-radius:12px; box-shadow:0 6px 18px rgba(15,23,42,0.06); padding:20px; max-width:900px; margin:16px auto; }
        h1 { font-size:22px; margin-bottom:12px; }
        .stats { display:flex; gap:12px; margin-top:16px; flex-wrap:wrap; }
        .stat { flex:1; padding:14px; border-radius:10px; background:linear-gradient(180deg,#ffffff,#f8fafc); text-align:center; min-width:120px; }
        .big { font-size:28px; font-weight:700; }
        .muted { color:#475569; font-size:13px; }
        .chart-container { display:flex; flex-direction:column; gap:24px; margin-top:16px; }
        .chart-card { width:100%; background:#f8fafc; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); padding:12px; }
        canvas { background:#f8fafc; border-radius:12px; padding:12px; margin-top:16px; }
        .footer { font-size:13px; color:#64748b; margin-top:12px; text-align:center; }
        #deleteAllBtn { margin-top:16px; padding:8px 12px; border:none; border-radius:8px; background:#ff4d4f; color:white; cursor:pointer; transition: background 0.3s; }
        #deleteAllBtn:hover { background:#e04142; }
        @media (max-width: 576px) { .big { font-size:22px; } h1 { font-size:18px; } }
    </style>
</head>
<body>

<div class="card">
    <h1>Visit Tracker — Admin</h1>
    <p class="muted">Website visit statistics overview.</p>

    <!-- Stats boxes -->
    <div class="stats">
        <div class="stat">
            <div class="big"><%= dailyCounts %></div>
            <div class="muted">Today</div>
        </div>
        <div class="stat">
            <div class="big"><%= weeklyCounts %></div>
            <div class="muted">Last 7 Days</div>
        </div>
        <div class="stat">
            <div class="big"><%= monthlyCounts %></div>
            <div class="muted">Last 30 Days</div>
        </div>
    </div>

    <!-- Charts -->
    <div class="chart-container">
        <div class="chart-card">
            <h4 class="text-primary mb-2">Weekly Visits</h4>
            <canvas id="weeklyChart"></canvas>
        </div>

        <div class="chart-card">
            <h4 class="text-primary mb-2">Monthly Visits</h4>
            <canvas id="monthlyChart"></canvas>
        </div>
    </div>

    <!-- Top URLs -->
    <div class="card mt-4">
        <h2 class="text-primary mb-3">Top 20 Visited URLs</h2>
        <ol style="padding-left:20px; list-style-position: inside;">
            <% topUrls.forEach((url, index) => { %>
                <li style="padding:8px 12px; border-radius:8px; margin-bottom:6px; background:#f8f9fa; transition: background 0.3s;"
                    onmouseover="this.style.background='#e2e6ea';"
                    onmouseout="this.style.background='#f8f9fa';">
                    <%= url %> (<%= topCounts[index] %> visits)
                </li>
            <% }) %>
        </ol>
    </div>

    <button id="deleteAllBtn">Delete All Visits</button>

    <div class="footer">
        Tip: Embed automatic tracking on pages using POST to <code>/visits/track?pageUrl=...</code>
    </div>
</div>

<script>
    const weeklyCounts = <%- JSON.stringify(weeklyVisits) %>;
    const monthlyCounts = <%- JSON.stringify(monthlyVisits) %>;

    const weeklyLabels = weeklyCounts.map((_, i) => (6-i) + " days ago");
    const monthlyLabels = monthlyCounts.map((_, i) => (29-i) + " days ago");

    const createChart = (ctxId, labels, data, color, label) => {
        return new Chart(document.getElementById(ctxId), {
            type: 'line',
            data: { 
                labels, 
                datasets: [{
                    label, 
                    data, 
                    borderColor: color, 
                    backgroundColor: color.replace('rgb','rgba').replace(')',',0.1)'), 
                    fill:true, 
                    tension:0.3, 
                    pointRadius:1 
                }] 
            },
            options: { 
                responsive:true, 
                plugins:{ legend:{display:true}, tooltip:{mode:'index', intersect:false} }, 
                scales:{ x:{title:{display:true,text:'Date'}}, y:{beginAtZero:true,title:{display:true,text:'Visits'}} } 
            }
        });
    };

    createChart('weeklyChart', weeklyLabels, weeklyCounts, 'rgb(0,0,255)', 'Visits Last 7 Days');
    createChart('monthlyChart', monthlyLabels, monthlyCounts, 'rgb(0,128,0)', 'Visits Last 30 Days');

    document.getElementById('deleteAllBtn').addEventListener('click', async () => {
        if(!confirm("Are you sure you want to delete all visits?")) return;
        try {
            const res = await fetch('/visits/deleteAll', { method:'POST', headers:{'Content-Type':'application/json'} });
            if(!res.ok) throw new Error(res.status + ' ' + res.statusText);
            alert("All visits deleted!");
            location.reload();
        } catch(err) {
            alert("Error deleting visits: " + err.message);
            console.error(err);
        }
    });
</script>

</body>
</html>
